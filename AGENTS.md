# Jorum Agent Guide

Purpose

- Give agents a short, accurate map of build commands and code style.
- Prefer existing patterns over inventing new ones.
- This repo is a freestanding OS/kernel project (C/ASM + build scripts).

Repo map (high level)

- `Makefile`: top-level build orchestration.
- `toolchain.mk`: generated by `./configure.sh` (do not edit).
- `config/`: configure system scripts and templates.
- `arch/x86/`: architecture-specific code and linker script.

Editor rules

- Cursor rules: none found (no `.cursorrules` or `.cursor/rules/`).
- Copilot rules: none found (no `.github/copilot-instructions.md`).

Build and run commands

- `./configure.sh`: detect toolchain and generate `toolchain.mk` + `config.h`.
- `make` or `make all`: build `jorum` and `jorum.iso`.
- `make run`: build and run under QEMU (only if QEMU is detected).
- `make clean`: remove build artifacts.

Single-target build tips (no unit tests)

- This repo has no test framework or lint targets.
- For a single object, you can invoke its target directly:
  - Example: `make arch/x86/boot/boot32.o`
- For a single archive, invoke its target:
  - Example: `make arch/x86/libx86.a`
- Manual testing is via QEMU: `make run`.

Toolchain notes

- `toolchain.mk` is auto-generated; edit `config.sh` and re-run `./configure.sh`.
- Default toolchain is Clang/LLVM; GCC path is stubbed.
- Global flags (freestanding, no builtin, no stdlib) are set by configure.

Code style conventions (C/ASM/Linker/Shell/Make/Amber)

General

- Follow existing file-local conventions; do not refactor while fixing bugs.
- Avoid new dependencies; use existing build system.
- Keep changes minimal and focused.

Includes and headers

- Use `#pragma once` for header guards when present (see `config.h`).
- Prefer angled includes for local headers: `#include <config.h>`.
- Configuration macros live in `config.h` generated from `config/config.in`.

C/ASM preprocessor macros

- Use `UPPERCASE_WITH_UNDERSCORES` for macros and constants.
- Configuration macros use `CONFIG_*` prefix (e.g., `CONFIG_ARCH64`).
- Hardware constants are commonly hex (e.g., `0xE85250D6`).

Assembly (GAS syntax)

- Comments use `#`.
- Labels are lowercase with underscores (`boot_x64_check`, `stack_top`).
- Global entry is `_start`.
- Keep sections consistent with linker script (`.multiboot`, `.boot`, `.bss`).

Linker script (`arch/x86/linker.ld`)

- Uppercase constants for bases and flags (e.g., `KERNEL_BASE`).
- Section layout is explicit; align with `ALIGNMENT` and `MB_ALIGNMENT`.
- Discard sections are explicit; do not add new ones casually.

Makefiles

- Variables are `UPPERCASE_WITH_UNDERSCORES`.
- Suffix conventions: `_DIR`, `_FLAGS`, `_ARCHIVE`.
- Pattern rules are used for `.c` and `.S` to `.o`.
- Always declare `.PHONY` for non-file targets.
- Quiet output uses `Q ?= @` and `$(call notice,...)`.

Shell scripts (`config/*.sh`)

- Use `#!/usr/bin/env bash` and `set -e` for fail-fast behavior.
- Follow the header comment template (PURPOSE / REQUIRES / PROVIDES / SIDE EFFECTS).
- Helper functions use `sh_*` (shell), `fs_*` (filesystem).
- Fatal errors should call `panic` to exit with a clear message.
- Sourcing uses `sh_source` which panics on failure.

Amber scripts (`config/*.ab`)

- Use `//` for single-line comments.
- Constants are inlined directly as strings where needed.
- Functions follow `get_<item>_var()`, `get_<item>_val()`, `get_<item>_msg()`, `format_<item>_msg(params)` patterns (though simplified by inlining).
- Compile with `amber build <file.ab> > <output.sh>` to generate bash scripts.

Error handling

- Prefer explicit checks with descriptive failures:
  - Shell: `sh_defnonempty`, `sh_defined`, `fs_expect_existing`.
  - Make: `$(error "message")`.
  - C/ASM: `#error` in config checks where appropriate.

Formatting

- No global formatter config found; keep formatting consistent with nearby code.
- `config.h` uses `/* clang-format off/on */` around generated macros.
- Tabs are required in Makefiles; spaces elsewhere unless file uses tabs.

Naming conventions summary

- Macros/constants: `UPPERCASE_WITH_UNDERSCORES`.
- Config macros: `CONFIG_*`.
- Assembly labels: `lowercase_with_underscores`.
- Make variables: `UPPERCASE_WITH_UNDERSCORES` with suffix semantics.
- Shell functions: `sh_*`, `fs_*`, `panic`.
- Amber constants: `VAR_*`, `VAL_*`, `MSG_*` prefixes (when used).
- Amber functions: `get_*`, `format_*` patterns (when used).

Generated files (do not edit directly)

- `toolchain.mk` (from `./configure.sh`).
- `config.h` (from `config/config.in`).
- `configure.sh` (compiled from `config/configure.ab`).

Useful paths

- `config.sh`: user build options (USE_LLVM, TARGET_ARCH, BOOT_STACK).
- `config/10_toolchain_clang.sh`: LLVM toolchain config.
- `config/20_platform.sh`: QEMU/GRUB tool detection.
- `arch/x86/boot/boot32.S`: boot entry and multiboot header.
- `arch/x86/linker.ld`: linker layout for boot/kernel.

When adding new code

- Keep architecture-specific code under `arch/x86/`.
- Match section names and alignment with the linker script.
- If adding configuration, update `config/config.in` and regenerate `config.h`.
- If adding build rules, integrate via `arch/x86/Makefile` includes.

What not to assume

- No unit tests or lint tools exist currently.
- No formatting/lint enforcement beyond existing conventions.
- No Cursor/Copilot rule files in this repo.

Note: `config/variables.ab` was removed and its constants inlined directly into `configure.ab` for simplicity.
